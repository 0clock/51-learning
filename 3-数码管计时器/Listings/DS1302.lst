C51 COMPILER V9.60.0.0   DS1302                                                            03/20/2022 00:39:59 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Library\src\DS1302.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Library\inc
                    -) DEBUG OBJECTEXTEND PRINT(.\Listings\DS1302.lst) TABS(2) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include "DS1302.h"
   2          
   3          sbit DS1302_CK=P3^6;
   4          sbit DS1302_IO=P3^4;
   5          sbit DS1302_CE=P3^5;
   6          
   7          
   8          struct sTime {  //æ—¥æœŸæ—¶é—´ç»“æ„ä½“å®šä¹‰
   9              unsigned int  year;  //å¹´
  10              unsigned char mon;   //æœˆ
  11              unsigned char day;   //æ—¥
  12              unsigned char hour;  //æ—¶
  13              unsigned char min;   //åˆ†
  14              unsigned char sec;   //ç§’
  15              unsigned char week;  //æ˜ŸæœŸ
  16          };
  17          
  18          
  19          
  20          
  21          /* å‘é€ä¸€ä¸ªå­—èŠ‚åˆ°DS1302é€šä¿¡æ€»çº¿ä¸Š */
  22          void DS1302ByteWrite(unsigned char dat)
  23          {
  24   1          unsigned char mask;
  25   1          
  26   1          for (mask=0x01; mask!=0; mask<<=1)  //ä½ä½åœ¨å‰ï¼Œé€ä½ç§»å‡º
  27   1          {
  28   2              if ((mask&dat) != 0) //é¦–å…ˆè¾“å‡ºè¯¥ä½æ•°æ®
  29   2                  DS1302_IO = 1;
  30   2              else
  31   2                  DS1302_IO = 0;
  32   2              DS1302_CK = 1;       //ç„¶åæ‹‰é«˜æ—¶é’Ÿ
  33   2              DS1302_CK = 0;       //å†æ‹‰ä½æ—¶é’Ÿï¼Œå®Œæˆä¸€ä¸ªä½çš„æ“ä½œ
  34   2          }
  35   1          DS1302_IO = 1;           //æœ€åç¡®ä¿é‡Šæ”¾IOå¼•è„š
  36   1      }
  37          /* ç”±DS1302é€šä¿¡æ€»çº¿ä¸Šè¯»å–ä¸€ä¸ªå­—èŠ‚ */
  38          unsigned char DS1302ByteRead()
  39          {
  40   1          unsigned char mask;
  41   1          unsigned char dat = 0;
  42   1          
  43   1          for (mask=0x01; mask!=0; mask<<=1)  //ä½ä½åœ¨å‰ï¼Œé€ä½è¯»å–
  44   1          {
  45   2              if (DS1302_IO != 0)  //é¦–å…ˆè¯»å–æ­¤æ—¶çš„IOå¼•è„šï¼Œå¹¶è®¾ç½®datä¸­çš„å¯¹åº”ä½
  46   2              {
  47   3                  dat |= mask;
  48   3              }
  49   2              DS1302_CK = 1;       //ç„¶åæ‹‰é«˜æ—¶é’Ÿ
  50   2              DS1302_CK = 0;       //å†æ‹‰ä½æ—¶é’Ÿï¼Œå®Œæˆä¸€ä¸ªä½çš„æ“ä½œ
  51   2          }
  52   1          return dat;              //æœ€åè¿”å›è¯»åˆ°çš„å­—èŠ‚æ•°æ®
  53   1      }
  54          /* ç”¨å•æ¬¡å†™æ“ä½œå‘æŸä¸€å¯„å­˜å™¨å†™å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œreg-å¯„å­˜å™¨åœ°å€ï¼Œdat-å¾…å†™å…¥å­—èŠ‚ */
C51 COMPILER V9.60.0.0   DS1302                                                            03/20/2022 00:39:59 PAGE 2   

  55          void DS1302SingleWrite(unsigned char reg, unsigned char dat)
  56          {
  57   1          DS1302_CE = 1;                   //ä½¿èƒ½ç‰‡é€‰ä¿¡å·
  58   1          DS1302ByteWrite((reg<<1)|0x80);  //å‘é€å†™å¯„å­˜å™¨æŒ‡ä»¤
  59   1          DS1302ByteWrite(dat);            //å†™å…¥å­—èŠ‚æ•°æ®
  60   1          DS1302_CE = 0;                   //é™¤èƒ½ç‰‡é€‰ä¿¡å·
  61   1      }
  62          /* ç”¨å•æ¬¡è¯»æ“ä½œä»æŸä¸€å¯„å­˜å™¨è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œreg-å¯„å­˜å™¨åœ°å€ï¼Œè¿”å›å€¼-è¯»åˆ°çš„å­—èŠ
             -‚ */
  63          unsigned char DS1302SingleRead(unsigned char reg)
  64          {
  65   1          unsigned char dat;
  66   1          
  67   1          DS1302_CE = 1;                   //ä½¿èƒ½ç‰‡é€‰ä¿¡å·
  68   1          DS1302ByteWrite((reg<<1)|0x81);  //å‘é€è¯»å¯„å­˜å™¨æŒ‡ä»¤
  69   1          dat = DS1302ByteRead();          //è¯»å–å­—èŠ‚æ•°æ®
  70   1          DS1302_CE = 0;                   //é™¤èƒ½ç‰‡é€‰ä¿¡å·
  71   1          
  72   1          return dat;
  73   1      }
  74          /* ç”¨çªå‘æ¨¡å¼è¿ç»­å†™å…¥8ä¸ªå¯„å­˜å™¨æ•°æ®ï¼Œdat-å¾…å†™å…¥æ•°æ®æŒ‡é’ˆ */
  75          void DS1302BurstWrite(unsigned char *dat)
  76          {
  77   1          unsigned char i;
  78   1          
  79   1          DS1302_CE = 1;
  80   1          DS1302ByteWrite(0xBE);  //å‘é€çªå‘å†™å¯„å­˜å™¨æŒ‡ä»¤
  81   1          for (i=0; i<8; i++)     //è¿ç»­å†™å…¥8å­—èŠ‚æ•°æ®
  82   1          {
  83   2              DS1302ByteWrite(dat[i]);
  84   2          }
  85   1          DS1302_CE = 0;
  86   1      }
  87          /* ç”¨çªå‘æ¨¡å¼è¿ç»­è¯»å–8ä¸ªå¯„å­˜å™¨çš„æ•°æ®ï¼Œdat-è¯»å–æ•°æ®çš„æ¥æ”¶æŒ‡é’ˆ */
  88          void DS1302BurstRead(unsigned char *dat)
  89          {
  90   1          unsigned char i;
  91   1          
  92   1          DS1302_CE = 1;
  93   1          DS1302ByteWrite(0xBF);  //å‘é€çªå‘è¯»å¯„å­˜å™¨æŒ‡ä»¤
  94   1          for (i=0; i<8; i++)     //è¿ç»­è¯»å–8ä¸ªå­—èŠ‚
  95   1          {
  96   2              dat[i] = DS1302ByteRead();
  97   2          }
  98   1          DS1302_CE = 0;
  99   1      }
 100          /* è·å–å®æ—¶æ—¶é—´ï¼Œå³è¯»å–DS1302å½“å‰æ—¶é—´å¹¶è½¬æ¢ä¸ºæ—¶é—´ç»“æ„ä½“æ ¼å¼ */
 101          void GetRealTime(struct sTime *time)
 102          {
 103   1          unsigned char buf[8];
 104   1          
 105   1          DS1302BurstRead(buf);
 106   1          time->year = buf[6] + 0x2000;
 107   1          time->mon  = buf[4];
 108   1          time->day  = buf[3];
 109   1          time->hour = buf[2];
 110   1          time->min  = buf[1];
 111   1          time->sec  = buf[0];
 112   1          time->week = buf[5];
 113   1      }
 114          /* è®¾å®šå®æ—¶æ—¶é—´ï¼Œæ—¶é—´ç»“æ„ä½“æ ¼å¼çš„è®¾å®šæ—¶é—´è½¬æ¢ä¸ºæ•°ç»„å¹¶å†™å…¥DS1302 */
 115          void SetRealTime(struct sTime *time)
C51 COMPILER V9.60.0.0   DS1302                                                            03/20/2022 00:39:59 PAGE 3   

 116          {
 117   1          unsigned char buf[8];
 118   1          
 119   1          buf[7] = 0;
 120   1          buf[6] = time->year;
 121   1          buf[5] = time->week;
 122   1          buf[4] = time->mon;
 123   1          buf[3] = time->day;
 124   1          buf[2] = time->hour;
 125   1          buf[1] = time->min;
 126   1          buf[0] = time->sec;
 127   1          DS1302BurstWrite(buf);
 128   1      }
 129          /* DS1302åˆå§‹åŒ–ï¼Œå¦‚å‘ç”Ÿæ‰ç”µåˆ™é‡æ–°è®¾ç½®åˆå§‹æ—¶é—´ */
 130          void InitDS1302()
 131          {
 132   1          unsigned char dat;
 133   1          struct sTime code InitTime[] = {  //2022å¹´3æœˆ12æ—¥ 4:0:00 æ˜ŸæœŸå…­
 134   1              0x2022,0x03,0x12, 0x4,0x00,0x00, 0x06
 135   1          };
 136   1          
 137   1          DS1302_CE = 0;  //åˆå§‹åŒ–DS1302é€šä¿¡å¼•è„š
 138   1          DS1302_CK = 0;
 139   1          dat = DS1302SingleRead(0);  //è¯»å–ç§’å¯„å­˜å™¨
 140   1          if ((dat & 0x80) != 0)      //ç”±ç§’å¯„å­˜å™¨æœ€é«˜ä½CHçš„å€¼åˆ¤æ–­DS1302æ˜¯å¦å·²åœæ­¢
 141   1          {
 142   2              DS1302SingleWrite(7, 0x00);  //æ’¤é”€å†™ä¿æŠ¤ä»¥å…è®¸å†™å…¥æ•°æ®
 143   2              SetRealTime(&InitTime);      //è®¾ç½®DS1302ä¸ºé»˜è®¤çš„åˆå§‹æ—¶é—´
 144   2          }
 145   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    436    ----
   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =   ----      25
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
