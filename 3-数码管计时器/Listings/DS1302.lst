C51 COMPILER V9.60.0.0   DS1302                                                            03/12/2022 02:54:05 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Library\src\DS1302.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Library\inc
                    -) DEBUG OBJECTEXTEND PRINT(.\Listings\DS1302.lst) TABS(2) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include "DS1302.h"
   2          
   3          sbit DS1302_CK=P3^6;
   4          sbit DS1302_IO=P3^4;
   5          sbit DS1302_CE=P3^5;
   6          
   7          
   8          struct sTime {  //æ—¥æœŸæ—¶é—´ç»“æ„ä½“å®šä¹‰
   9              unsigned int  year;  //å¹´
  10              unsigned char mon;   //æœˆ
  11              unsigned char day;   //æ—¥
  12              unsigned char hour;  //æ—¶
  13              unsigned char min;   //åˆ†
  14              unsigned char sec;   //ç§’
  15              unsigned char week;  //æ˜ŸæœŸ
  16          };
  17          
  18          /* å‘é€ä¸€ä¸ªå­—èŠ‚åˆ°DS1302é€šä¿¡æ€»çº¿ä¸Š */
  19          void DS1302ByteWrite(unsigned char dat)
  20          {
  21   1          unsigned char mask;
  22   1          
  23   1          for (mask=0x01; mask!=0; mask<<=1)  //ä½ä½åœ¨å‰ï¼Œé€ä½ç§»å‡º
  24   1          {
  25   2              if ((mask&dat) != 0) //é¦–å…ˆè¾“å‡ºè¯¥ä½æ•°æ®
  26   2                  DS1302_IO = 1;
  27   2              else
  28   2                  DS1302_IO = 0;
  29   2              DS1302_CK = 1;       //ç„¶åæ‹‰é«˜æ—¶é’Ÿ
  30   2              DS1302_CK = 0;       //å†æ‹‰ä½æ—¶é’Ÿï¼Œå®Œæˆä¸€ä¸ªä½çš„æ“ä½œ
  31   2          }
  32   1          DS1302_IO = 1;           //æœ€åç¡®ä¿é‡Šæ”¾IOå¼•è„š
  33   1      }
  34          /* ç”±DS1302é€šä¿¡æ€»çº¿ä¸Šè¯»å–ä¸€ä¸ªå­—èŠ‚ */
  35          unsigned char DS1302ByteRead()
  36          {
  37   1          unsigned char mask;
  38   1          unsigned char dat = 0;
  39   1          
  40   1          for (mask=0x01; mask!=0; mask<<=1)  //ä½ä½åœ¨å‰ï¼Œé€ä½è¯»å–
  41   1          {
  42   2              if (DS1302_IO != 0)  //é¦–å…ˆè¯»å–æ­¤æ—¶çš„IOå¼•è„šï¼Œå¹¶è®¾ç½®datä¸­çš„å¯¹åº”ä½
  43   2              {
  44   3                  dat |= mask;
  45   3              }
  46   2              DS1302_CK = 1;       //ç„¶åæ‹‰é«˜æ—¶é’Ÿ
  47   2              DS1302_CK = 0;       //å†æ‹‰ä½æ—¶é’Ÿï¼Œå®Œæˆä¸€ä¸ªä½çš„æ“ä½œ
  48   2          }
  49   1          return dat;              //æœ€åè¿”å›è¯»åˆ°çš„å­—èŠ‚æ•°æ®
  50   1      }
  51          /* ç”¨å•æ¬¡å†™æ“ä½œå‘æŸä¸€å¯„å­˜å™¨å†™å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œreg-å¯„å­˜å™¨åœ°å€ï¼Œdat-å¾…å†™å…¥å­—èŠ‚ */
  52          void DS1302SingleWrite(unsigned char reg, unsigned char dat)
  53          {
  54   1          DS1302_CE = 1;                   //ä½¿èƒ½ç‰‡é€‰ä¿¡å·
C51 COMPILER V9.60.0.0   DS1302                                                            03/12/2022 02:54:05 PAGE 2   

  55   1          DS1302ByteWrite((reg<<1)|0x80);  //å‘é€å†™å¯„å­˜å™¨æŒ‡ä»¤
  56   1          DS1302ByteWrite(dat);            //å†™å…¥å­—èŠ‚æ•°æ®
  57   1          DS1302_CE = 0;                   //é™¤èƒ½ç‰‡é€‰ä¿¡å·
  58   1      }
  59          /* ç”¨å•æ¬¡è¯»æ“ä½œä»æŸä¸€å¯„å­˜å™¨è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œreg-å¯„å­˜å™¨åœ°å€ï¼Œè¿”å›å€¼-è¯»åˆ°çš„å­—èŠ
             -‚ */
  60          unsigned char DS1302SingleRead(unsigned char reg)
  61          {
  62   1          unsigned char dat;
  63   1          
  64   1          DS1302_CE = 1;                   //ä½¿èƒ½ç‰‡é€‰ä¿¡å·
  65   1          DS1302ByteWrite((reg<<1)|0x81);  //å‘é€è¯»å¯„å­˜å™¨æŒ‡ä»¤
  66   1          dat = DS1302ByteRead();          //è¯»å–å­—èŠ‚æ•°æ®
  67   1          DS1302_CE = 0;                   //é™¤èƒ½ç‰‡é€‰ä¿¡å·
  68   1          
  69   1          return dat;
  70   1      }
  71          /* ç”¨çªå‘æ¨¡å¼è¿ç»­å†™å…¥8ä¸ªå¯„å­˜å™¨æ•°æ®ï¼Œdat-å¾…å†™å…¥æ•°æ®æŒ‡é’ˆ */
  72          void DS1302BurstWrite(unsigned char *dat)
  73          {
  74   1          unsigned char i;
  75   1          
  76   1          DS1302_CE = 1;
  77   1          DS1302ByteWrite(0xBE);  //å‘é€çªå‘å†™å¯„å­˜å™¨æŒ‡ä»¤
  78   1          for (i=0; i<8; i++)     //è¿ç»­å†™å…¥8å­—èŠ‚æ•°æ®
  79   1          {
  80   2              DS1302ByteWrite(dat[i]);
  81   2          }
  82   1          DS1302_CE = 0;
  83   1      }
  84          /* ç”¨çªå‘æ¨¡å¼è¿ç»­è¯»å–8ä¸ªå¯„å­˜å™¨çš„æ•°æ®ï¼Œdat-è¯»å–æ•°æ®çš„æ¥æ”¶æŒ‡é’ˆ */
  85          void DS1302BurstRead(unsigned char *dat)
  86          {
  87   1          unsigned char i;
  88   1          
  89   1          DS1302_CE = 1;
  90   1          DS1302ByteWrite(0xBF);  //å‘é€çªå‘è¯»å¯„å­˜å™¨æŒ‡ä»¤
  91   1          for (i=0; i<8; i++)     //è¿ç»­è¯»å–8ä¸ªå­—èŠ‚
  92   1          {
  93   2              dat[i] = DS1302ByteRead();
  94   2          }
  95   1          DS1302_CE = 0;
  96   1      }
  97          /* è·å–å®æ—¶æ—¶é—´ï¼Œå³è¯»å–DS1302å½“å‰æ—¶é—´å¹¶è½¬æ¢ä¸ºæ—¶é—´ç»“æ„ä½“æ ¼å¼ */
  98          void GetRealTime(struct sTime *time)
  99          {
 100   1          unsigned char buf[8];
 101   1          
 102   1          DS1302BurstRead(buf);
 103   1          time->year = buf[6] + 0x2000;
 104   1          time->mon  = buf[4];
 105   1          time->day  = buf[3];
 106   1          time->hour = buf[2];
 107   1          time->min  = buf[1];
 108   1          time->sec  = buf[0];
 109   1          time->week = buf[5];
 110   1      }
 111          /* è®¾å®šå®æ—¶æ—¶é—´ï¼Œæ—¶é—´ç»“æ„ä½“æ ¼å¼çš„è®¾å®šæ—¶é—´è½¬æ¢ä¸ºæ•°ç»„å¹¶å†™å…¥DS1302 */
 112          void SetRealTime(struct sTime *time)
 113          {
 114   1          unsigned char buf[8];
 115   1          
C51 COMPILER V9.60.0.0   DS1302                                                            03/12/2022 02:54:05 PAGE 3   

 116   1          buf[7] = 0;
 117   1          buf[6] = time->year;
 118   1          buf[5] = time->week;
 119   1          buf[4] = time->mon;
 120   1          buf[3] = time->day;
 121   1          buf[2] = time->hour;
 122   1          buf[1] = time->min;
 123   1          buf[0] = time->sec;
 124   1          DS1302BurstWrite(buf);
 125   1      }
 126          /* DS1302åˆå§‹åŒ–ï¼Œå¦‚å‘ç”Ÿæ‰ç”µåˆ™é‡æ–°è®¾ç½®åˆå§‹æ—¶é—´ */
 127          void InitDS1302()
 128          {
 129   1          unsigned char dat;
 130   1          struct sTime code InitTime[] = {  //2022å¹´3æœˆ12æ—¥ 4:0:00 æ˜ŸæœŸå…­
 131   1              0x2022,0x03,0x12, 0x4,0x00,0x00, 0x06
 132   1          };
 133   1          
 134   1          DS1302_CE = 0;  //åˆå§‹åŒ–DS1302é€šä¿¡å¼•è„š
 135   1          DS1302_CK = 0;
 136   1          dat = DS1302SingleRead(0);  //è¯»å–ç§’å¯„å­˜å™¨
 137   1          if ((dat & 0x80) != 0)      //ç”±ç§’å¯„å­˜å™¨æœ€é«˜ä½CHçš„å€¼åˆ¤æ–­DS1302æ˜¯å¦å·²åœæ­¢
 138   1          {
 139   2              DS1302SingleWrite(7, 0x00);  //æ’¤é”€å†™ä¿æŠ¤ä»¥å…è®¸å†™å…¥æ•°æ®
 140   2              SetRealTime(&InitTime);      //è®¾ç½®DS1302ä¸ºé»˜è®¤çš„åˆå§‹æ—¶é—´
 141   2          }
 142   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    436    ----
   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =   ----      25
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
