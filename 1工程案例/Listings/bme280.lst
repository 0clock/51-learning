C51 COMPILER V9.60.0.0   BME280                                                            02/14/2022 12:41:40 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE BME280
OBJECT MODULE PLACED IN .\Objects\bme280.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE BMEBMP280\bme280.c LARGE RTX51 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\0.96¡®O
                    -LED-SPI;.\0.96¡®OLED-SPI\BMP;.\USER;.\delay;.\°´¼ü;.\BMEBMP280;.\IIC;.\GPS;.\SPI;.\Ğı×ª±àÂëÆ÷;.\1.54'TFT) DEBUG OBJECTEX
                    -TEND PRINT(.\Listings\bme280.lst) TABS(2) OBJECT(.\Objects\bme280.obj)

line level    source

   1          #include "bme280.h"
   2          #include "iic.h"
   3          
   4          #define BMP280_SlaveAddress   0xec  //å®šç¾©bmp280åœ¨IICçš„ä½å€
   5          #define   uchar unsigned char
   6          #define   uint unsigned int 
   7                                 
   8          unsigned short dig_T1;
   9          signed short dig_T2;
  10          signed short dig_T3;
  11          unsigned short dig_P1;
  12          signed short dig_P2;
  13          signed short dig_P3;
  14          signed short dig_P4;
  15          signed short dig_P5;
  16          signed short dig_P6;
  17          signed short dig_P7;
  18          signed short dig_P8;
  19          signed short dig_P9;
  20          unsigned char dig_H1;
  21          signed short dig_H2;
  22          unsigned char dig_H3;
  23          signed short dig_H4;
  24          signed short dig_H5;
  25          signed short dig_H6; 
  26          
  27          long  temperature;
  28          long  pressure;
  29          long  height;
  30          long  humidity;
  31          
  32          uchar Single_Read(uchar ST_Address)
  33          { 
  34   1              uchar REG_data;
  35   1              //uchar bit;
  36   1              
  37   1              iic_start();         
  38   1              iic_send_byte(BMP280_SlaveAddress); //ç™¼é€è¨­å‚™ä½å€         
  39   1              iic_ack();
  40   1              iic_send_byte(ST_Address);  // ç™¼é€å„²å­˜ä½å€          
  41   1              iic_ack(); 
  42   1              iic_start();                         
  43   1              iic_send_byte(BMP280_SlaveAddress+1);  //ç™¼é€è¨­å‚™ä½å€èˆ‡è®€ä¿¡è™Ÿ       
  44   1              iic_ack();    
  45   1              REG_data = iic_rev();     
  46   1              iic_ack(); //æœ€å¾Œä¸€ç­†éœ€è¦å›NOACK   
  47   1              return REG_data; 
  48   1      }
  49          
  50          void Single_Write(uchar SlaveAddress,uchar REG_Address,uchar REG_data)
  51          {
  52   1          iic_start();                       
  53   1          iic_send_byte(SlaveAddress);  //ç™¼é€è¨­å‚™ä½å€èˆ‡å¯«å…¥ä¿¡è™Ÿ 
C51 COMPILER V9.60.0.0   BME280                                                            02/14/2022 12:41:40 PAGE 2   

  54   1              iic_ack(); 
  55   1              iic_send_byte(REG_Address); //å…§éƒ¨æš«å­˜å™¨ä½å€   
  56   1              iic_ack(); 
  57   1              iic_send_byte(REG_data); // å…§éƒ¨æš«å­˜å™¨å¯«å…¥è³‡æ–™     
  58   1              iic_ack(); 
  59   1              iic_stop();                   
  60   1      }
  61          
  62          
  63          short Multiple_read(uchar ST_Address) //è®€å‡ºBMP280å…§éƒ¨è³‡æ–™,é€£çºŒå…©ç­†
  64          {   
  65   1              uchar msb, lsb;
  66   1              short _data;
  67   1              
  68   1              lsb = Single_Read(ST_Address);
  69   1              msb = Single_Read(ST_Address+1);
  70   1              
  71   1              _data = msb << 8;
  72   1              _data |= lsb;        
  73   1           
  74   1              return _data;
  75   1      }
  76          
  77          long Multiple_read_H(uchar ST_Address) //è®€å‡ºBMP280å…§éƒ¨è³‡æ–™,é€£çºŒå…©ç­†
  78          {   
  79   1              uchar msb, lsb;
  80   1              //short _data = 0;
  81   1              long _data = 0;
  82   1      
  83   1              msb = Single_Read(ST_Address);
  84   1              lsb = Single_Read(ST_Address+1);      
  85   1              
  86   1          _data=(long)(((uint32_t)msb<<8)|((uint32_t)lsb));
  87   1          //_data=((msb<<8)|lsb);
  88   1              return _data;
  89   1      }
  90          
  91          long Multiple_three_read(uchar ST_Address)
  92          {   
  93   1              uchar msb, lsb,xlsb;
  94   1              long _data = 0;
  95   1              
  96   1              msb = Single_Read(ST_Address);
  97   1              lsb = Single_Read(ST_Address+1);
  98   1              xlsb = Single_Read(ST_Address+2);
  99   1      
 100   1              _data=(long)(((uint32_t)msb<<12)|((uint32_t)lsb<<4)|((uint32_t)xlsb>>4));
 101   1              return _data;
 102   1      }
 103          
 104          
 105          
 106          void Init_BMP280(void)
 107          {
 108   1              unsigned short temp = 0;
 109   1              temp = Single_Read(0xd0);  //è®€å–idã€åˆ¤æ–·iicæ˜¯å¦æ­£å¸¸,æ¨¡çµ„æ˜¯å¦æ­£å¸¸ï¼Œè®€å–å‡ºä¾†çš„
             -ä½å€æ˜¯0x58å°±æ˜¯æ­£ç¢ºçš„
 110   1      
 111   1              dig_T1 = Multiple_read(0x88);
 112   1              dig_T2 = Multiple_read(0x8A);
 113   1              dig_T3 = Multiple_read(0x8C);
 114   1              dig_P1 = Multiple_read(0x8E);
C51 COMPILER V9.60.0.0   BME280                                                            02/14/2022 12:41:40 PAGE 3   

 115   1              dig_P2 = Multiple_read(0x90);
 116   1              dig_P3 = Multiple_read(0x92);
 117   1              dig_P4 = Multiple_read(0x94);
 118   1              dig_P5 = Multiple_read(0x96);
 119   1              dig_P6 = Multiple_read(0x98);
 120   1              dig_P7 = Multiple_read(0x9A);
 121   1              dig_P8 = Multiple_read(0x9C);
 122   1              dig_P9 = Multiple_read(0x9E);
 123   1          dig_H1 = Single_Read(0xA1);
 124   1          dig_H2 = Multiple_read(0xE1);
 125   1          dig_H3 = Single_Read(0xE3);
 126   1            dig_H4 = (Single_Read(0xE4)<< 4) | (Single_Read(0xE5) & 0x0F);
 127   1          dig_H5 = (Single_Read(0xE6)<< 4) | (Single_Read(0xE5) >> 4);
 128   1              dig_H6 = Single_Read(0xE7);
 129   1          
 130   1              Single_Write(BMP280_SlaveAddress,0xf2,0x04);
 131   1          Single_Write(BMP280_SlaveAddress,0xf4,0xb3);
 132   1              Single_Write(BMP280_SlaveAddress,0xf5,5<<2);
 133   1              Delay200ms();       
 134   1      }
 135          
 136          
 137          long bmp280Convert(void)
 138          {
 139   1              long adc_T,adc_P,adc_H;
 140   1              long var1, var2,t_fine; 
 141   1               //rt_kprintf("----------------------------\n");
 142   1              adc_H= Multiple_read_H(0xFD);
 143   1              //adc_T = Multiple_three_read(0xFA); 
 144   1              adc_T = Multiple_three_read(0xFA);  //è®€å‡ºæº«åº¦  
 145   1              //adc_P = Multiple_three_read(0xF7); 
 146   1              adc_P = Multiple_three_read(0xF7);   //è®€å‡ºå£“åŠ›
 147   1      
 148   1              if(adc_P == 0)
 149   1              {
 150   2                      return 0;
 151   2              }
 152   1              //Temperature
 153   1              var1 = (((double)adc_T)/16384.0-((double)dig_T1)/1024.0)*((double)dig_T2) ;
 154   1              //rt_kprintf("var1 is %d\n",var1);
 155   1              var2 = ((((double)adc_T)/131072.0-((double)dig_T1)/8192.0)*(((double)adc_T)/131072.0-((double)dig_
             -T1)/8192.0))*((double)dig_T3);
 156   1              //rt_kprintf("var2 is %d\n",var2);
 157   1              
 158   1              t_fine = (uint32_t)(var1+var2);
 159   1              //rt_kprintf("t_fine is %d\n",t_fine);
 160   1              
 161   1              temperature = t_fine*100/5120.0;  //5120.0   5520.0æ˜¯å› ç‚ºæº«åº¦å€¼å¤ªé«˜çš„èª¿æ•´
 162   1              
 163   1              //rt_kprintf("temperature is %d\n",T);
 164   1              
 165   1              var1 = ((double)t_fine/2.0)-64000.0;
 166   1              //rt_kprintf("var1 is %d\n",var1);
 167   1              
 168   1              var2 = var1*var1*((double)dig_P6)/32768.0;
 169   1              //rt_kprintf("var2 is %d\n",var2);
 170   1              
 171   1              var2 = var2+var1*((double)dig_P5)*2.0;
 172   1              //rt_kprintf("var2 is %d\n",var2);
 173   1              
 174   1              var2 = (var2/4.0)+(((double)dig_P4)*65536.0);
 175   1              //rt_kprintf("var2 is %d\n",var2);
C51 COMPILER V9.60.0.0   BME280                                                            02/14/2022 12:41:40 PAGE 4   

 176   1              
 177   1              var1 = (((double)dig_P3)*var1*var1/524288.0+((double)dig_P2)*var1)/524288.0;
 178   1              //rt_kprintf("var1 is %d\n",var1);
 179   1              
 180   1              var1 = (1.0+var1/32768.0)*((double)dig_P1);
 181   1              //rt_kprintf("var1 is %d\n",var1);
 182   1              
 183   1              pressure = 1048576.0-(double)adc_P;
 184   1              //rt_kprintf("p is %d\n",p);
 185   1      
 186   1              pressure = (pressure-(var2/4096.0))*6250.0/var1;
 187   1              //rt_kprintf("p is %d\n",p);
 188   1          //height = (44330-4961*pow(pressure, 0.19))*100;
 189   1          //height = (44330 * (1-pow((pressure/ 101325.0),(1.0/5.255))))*100;  //101325æ¨™æº–æµ·å¹³é¢å£“åŠ›ï¼Œä¸
             -æ˜¯æœ¬åœ°åŸºæœ¬å£“åŠ›
 190   1          height=(101325-pressure)*9;//è½‰åŒ–å¾—åˆ°çµ•å°é«˜åº¦
 191   1          //height=(101325-pressure) * 8.43  ;
 192   1      
 193   1          humidity  = (((double)t_fine)-76800.0);
 194   1          humidity  = (adc_H-(((double)dig_H4)*64.0+((double)dig_H5)/16384.0*humidity))*
 195   1               (((double)dig_H2)/65536.0*(1.0+((double)dig_H6)/67108864.0*humidity*
 196   1               (1.0+((double)dig_H3)/67108864.0*humidity)));
 197   1            humidity  = humidity*(1.0-((double)dig_H1)*humidity/524288.0);
 198   1            
 199   1        return 0;
 200   1       }   
 201           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2455    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     50      40
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
